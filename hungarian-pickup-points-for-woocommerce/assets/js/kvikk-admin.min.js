jQuery(document).ready(function(i){var o={home_delivery_pricing:{},pickup_point_pricing:{},cod_pricing:{},$metabox:i(".vp-woo-pont-metabox-content"),$home_delivery_providers:i(".vp-woo-pont-metabox-rows-data-home-delivery-providers"),$metabox_weight_input:i("#vp_woo_pont_package_weight"),$metabox_calculated_price:i(".vp-woo-pont-metabox-rows-kvikk-price"),$modifyProviderButton:i("#vp_woo_pont_modify_provider"),$enabled_providers:i(".vp-woo-pont-providers"),$homeDeliveryProviderInput:i('input[name="home_delivery_provider"]'),currency_formatter:new Intl.NumberFormat("hu-HU",{style:"currency",currency:"HUF",minimumFractionDigits:0,maximumFractionDigits:0}),init:function(){vp_woo_pont_kvikk_params.couriers&&vp_woo_pont_kvikk_params.couriers.pricing&&vp_woo_pont_kvikk_params.couriers.pricing.shipping&&(this.shipping_pricing=vp_woo_pont_kvikk_params.couriers.pricing.shipping,this.cod_pricing=vp_woo_pont_kvikk_params.couriers.pricing.cod,this.display_metabox_shipping_cost(),this.$metabox_weight_input.on("keyup",this.display_metabox_shipping_cost),this.display_single_metabox_shipping_cost(),this.$modifyProviderButton.on("click",this.show_provider_options),this.$homeDeliveryProviderInput.on("change",this.on_provider_change),i(document.body).on("vp_woo_pont_metabox_pickup_point_changed",this.on_provider_change))},show_provider_options:function(){return o.$metabox_calculated_price.slideUp(),!1},on_provider_change:function(){setTimeout(function(){o.display_single_metabox_shipping_cost()},100)},check_if_provider_selected:function(){i(".vp-woo-pont-providers-wrapper").addClass("provider-selected"),0==i('.vp-woo-pont-providers input[name="vp_woo_pont_enabled_providers[]"]:checked').length&&i(".vp-woo-pont-providers-wrapper").removeClass("provider-selected")},display_metabox_shipping_cost:function(){o.$home_delivery_providers.find("li").each(function(){var t=i(this).data("provider");if(0===t.indexOf("kvikk")){t=t.replace("kvikk_","");var e=o.$metabox_weight_input.val(),n=o.$metabox.data("cod"),r=o.calculate_shipping_cost(t,e,n),p=o.currency_formatter.format(r),c=i(this).find(".shipping-cost").data("label");r?i(this).find(".shipping-cost").text(c+": "+p):i(this).find(".shipping-cost").text(c+": -")}})},calculate_shipping_cost:function(i,t,e){var n=0,r=0,p=0;const c=o.shipping_pricing.find(o=>o.courier===i),a=o.cod_pricing.find(o=>o.courier===i);if(!c||!a)return!1;const _=c.prices.find(i=>t>=i.min&&t<=i.max);if(!_)return!1;if(n=_.cost,e){e=parseInt(e);const i=a.prices.find(i=>e>=i.min&&e<=i.max);i&&(console.log(i),r=i.fee,p=e*i.percentage/100)}return n+r+p},display_single_metabox_shipping_cost:function(){if(i("#vp_woo_pont_metabox_kvikk").length)o.$metabox_calculated_price.slideUp();else{var t=i(".vp-woo-pont-metabox-rows-data-provider").find("i").attr("class");if(t.includes("kvikk")){t=t.replace("vp-woo-pont-provider-icon-kvikk_","");var e=o.$metabox_weight_input.val(),n=o.$metabox.data("cod"),r=o.calculate_shipping_cost(t,e,n);r?(o.$metabox_calculated_price.slideDown(),o.$metabox_calculated_price.find("strong").text(o.currency_formatter.format(r))):o.$metabox_calculated_price.slideUp()}else o.$metabox_calculated_price.slideUp()}}};i("#vp_woo_pont_metabox").length&&o.init();var t={apiUrl:"https://api.kvikk.hu/public",init:function(){i(document).on("click",".kvikk-promo-close",this.hide_promo.bind(this)),i(document).on("click",".kvikk-promo-hide",this.hide_promo.bind(this)),i(document).on("click",".kvikk-promo-cta",this.cta_click.bind(this)),i(".kvikk-promo").length?this.get_pricing():i(document.body).on("vp_woo_pont_generate_modal_shown",function(){t.get_pricing()})},hide_promo:function(){i(".kvikk-promo").slideUp();var o=i(".kvikk-promo").data("nonce");return i.post(ajaxurl,{action:"vp_woo_pont_hide_kvikk_promo",nonce:o}),!1},cta_click:function(){t.hide_promo()},get_pricing:function(){console.log("get_pricing");var i=localStorage.getItem("vp_woo_pont_kvikk_promo_pricing");if(i){const o=JSON.parse(i);if(!o)return void t.fetch_pricing();const e=new Date(o.expiration);return new Date>e?void t.fetch_pricing():void t.display_pricing(o.data)}t.fetch_pricing()},fetch_pricing:function(){fetch(t.apiUrl+"/pricing?latest=1").then(i=>i.json()).then(i=>{if(!i.data.shipping)return void console.error("No pricing data found");const o=i.data.shipping,e=new Date;e.setDate(e.getDate()+30);const n=o.map(i=>({courier:i.courier,price:i.prices[0].cost}));localStorage.setItem("vp_woo_pont_kvikk_promo_pricing",JSON.stringify({expiration:e,data:n})),t.get_pricing()}).catch(i=>{console.error("Error fetching price list:",i)})},display_pricing:function(o){const t=["mpl","gls","dpd","famafutar"];i(".kvikk-promo").addClass("loaded");for(const e of t){const t=o.find(i=>i.courier===e);if(t){let o=t.price;o=new Intl.NumberFormat("hu-HU",{style:"currency",currency:"HUF",minimumFractionDigits:0,maximumFractionDigits:0}).format(o),i(`strong[data-kvikk-promo-price="${e}"]`).text(o)}}}};(i(".kvikk-promo").length||i("#tmpl-vp-woo-pont-modal-generate").length)&&t.init()});